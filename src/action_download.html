<!--
  - action_download.html
  - Query online compendium and shows what can be downloaded / updated.
  -->
<div id='action_download'>
   <h1 class="i18n">action.download.title</h1>
   <p class="i18n"> action.download.paragraph.0 </p>
   <p class="i18n"> action.download.paragraph.1 </p>
   <p>
      <!--input type='search' class='right' placeholder='Search' autofocus-->
      <a class='button i18n' onclick='oddi.action.download.update_list()'> action.download.btn_refresh </a>
      <!--label> <input type='checkbox'> <span class='i18n'>action.download.chk_refresh</span> </label-->
   </p>
   <p>
      <!--a class='button i18n' id="act_download_btn_clearAll" onclick='oddi.action.download.clear_all()'>action.download.btn_clear_existing</a><br/-->
      <a class='button' id="act_download_btn_updateChanged" onclick='oddi.action.download.update_changed()'></a>
      <a class='button' id="act_download_btn_updateAll" onclick='oddi.action.download.update_all()'></a>
   </p>
   <p>
      <a class='button i18n' onclick='oddi.gui.switch_action( oddi.action.list );'>action.download.btn_done</a>
   </p>
   <fieldset id="act_download_lst_new"></fieldset>
   <fieldset id="act_download_lst_changed"></fieldset>
   <fieldset id="act_download_lst_deleted"></fieldset>
   <!-- TODO: Show current entries on click -->
</div>
<script type='text/javascript'>'use strict';(function action_download_init(){

oddi.action.download = {
   id: 'action_download',

   initialize: function() {
         oddi.gui.set( '#act_download_btn_updateChanged, #act_download_btn_updateAll, #act_download_lst_new, #act_download_lst_changed, #act_download_lst_deleted', '' );
      },
   setup: null,
   cleanup: null,

   show_update_buttons : function download_show_update_buttons( ) {
      var newCount = oddi.downloader.newItem.length;
      var changedCount = oddi.downloader.changedItem.length;
      var deletedCount = oddi.downloader.deletedItem.length;
      var allCount = oddi.downloader.itemCount;
      var set = oddi.gui.set;

      set( '#act_download_btn_updateChanged', ( newCount || changedCount ) ? _.l( 'action.download.btn_update_changed', newCount, changedCount ) : '' );
      set( '#act_download_btn_updateAll', allCount ? _.l( 'action.download.btn_update_all', allCount ) : '' );

      /** Build a list of updated/changed/delete items. Empty if list is empty. */
      function gen_item_list( legend, list ) {
        if ( list.length == 0 ) return '';
         function esc( t ) { return t.replace(/</g,'&lt;'); };
         var html = '<legend>'+_.l( legend )+'</legend>';
         list.forEach( function( item ) {
            //if ( item[1] ) {
               item = [ item[0] ].concat( item[1] );
               // TODO: Show popup links to entry details
               html += esc(item[0]) + ': <b>' + esc(item[2]) + '</b> (' + esc(item[item.length-1]) + ')<br/>';
            //}
         });
         return html;
      }
      // TODO: Add buttons for finer update control
      set( '#act_download_lst_new', newCount ? gen_item_list( 'action.download.lbl_new_items', oddi.downloader.newItem ) : '' );
      set( '#act_download_lst_changed', newCount ? gen_item_list( 'action.download.lbl_changed_items', oddi.downloader.changedItem ) : '' );
      set( '#act_download_lst_deleted', newCount ? gen_item_list( 'action.download.lbl_deleted_items', oddi.downloader.deletedItem ) : '' );
   },

   update_list : function act_download_update_list () { oddi.downloader.get_index(); },
   
   clear_all : function act_download_clear_all () { 
      oddi.data.clear();
      oddi.downloader.find_changed();
   },

   /** Get new and changed items */
   update_changed : function act_download_update_changed () {
      oddi.downloader.stack.stack = oddi.downloader.newItem.concat(oddi.downloader.changedItem);
      oddi.downloader.get();
   },

   /** Get all items */
   update_all : function act_download_update_all () {
      oddi.data.clear();
      var stack = [];
      var remote = oddi.downloader.remote;
      for ( var cat in remote ) {
         var category = remote[cat];
         for ( var i = 0 ; i < category.listing.length ; i++ )
            stack.push( [ cat, category.listing[i] ] );
      }
      oddi.downloader.stack.stack = stack;
      oddi.downloader.get();
   }, 
};

})()</script>