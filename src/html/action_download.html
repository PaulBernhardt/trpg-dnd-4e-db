<!--
  - action_download.html
  - Query online compendium and shows what can be downloaded / updated.
  -->
<div id='action_download' data-role='page'>

   <header>
      <a class='i18n' onclick='od.gui.switch_action( od.action.list );'> action.list.link_text </a>
      <h1 class='i18n'>action.download.title</h1>
      <a class='i18n' onclick='od.gui.switch_action( od.action.about )'> action.about.link_text </a>
   </header>

   <p class='i18n'> action.download.paragraph.0 </p>
   <p class='i18n'> action.download.paragraph.1 </p>
   <p>
      <a class='button i18n' id='act_download_btn_get_catalog' onclick='od.action.download.get_catalog()'> action.download.btn_get_catalog </a>
      <a class='button i18n' id='act_download_btn_all_list' onclick='od.action.download.list_all()'> action.download.btn_all_list </a>
      <a class='button i18n' id='act_download_btn_update' onclick='od.action.download.update_all()'> action.download.btn_update_changed </a>
      <a class='button i18n' id='act_download_btn_save' onclick='od.action.download.save()'> action.download.btn_save </a>
   </p>
   <table id='act_download_tbl_list'>
      <thead>
         <tr>
            <th class='i18n'> action.download.th_category </th>
            <th class='i18n'> action.download.th_local </th>
            <th class='i18n'> action.download.th_remote </th>
            <th class='i18n'> action.download.th_new </th>
            <th class='i18n'> action.download.th_changed </th>
            <th class='i18n'> action.download.th_status </th>
            <th class='i18n'> action.download.th_commands </th>
         </tr>
      </thead>
      <tbody></tbody>
   </table>
   <!--fieldset id='act_download_lst_status'><legend class='i18n'>action.download.lst_thread</legend></fieldset-->
</div>
<script type='text/javascript'>'use strict';(function action_download_init(){
/*
 * Remote category commands by state:
 *  - local / absent: Reindex | Delete
 *  - unlisted: Check | Reindex | Delete
 *  - listing: (none)
 *  - listed: Recheck | Reindex | Delete | Update All | Update changed
 *  - downloading: Stop
 *  
 * Top buttons: List categories | Check all | Update changed | Stop all | Save | Reindex all
 *  
 * If any remote category has dirty data, save button may be available.
 * If any category is downloading, reindex/save is not available for all cat, since data is being updated.
 * A check will reload listing but will not reset dirty (copied to local) data.
 * Reindex and delete will erase any dirty data.  Both are non-stopable.
 *
 * Workflow:
 *   Load cat -> create remotes (local) -> Get cat -> Create / update remote state (unlisted or absent).
 *   List / Relist : reset ->  (listing) get_listing -> find_changed (listed)
 *   Download -> schedule_download -> get_data -> local.update, add to dirty
 */
od.action.download = {
   'id': 'action_download',

   'initialize': function act_download_init () {
      _.hide( '#act_download_tbl_list, #act_download_btn_all_list, #act_download_btn_update, #act_download_btn_save');
      if ( location.protocol !== 'file:' || ! window.ActiveXObject || ! /\bMSIE (9|\d\d+)\./.test(navigator.userAgent) ) {
         _.hide( '#act_download_btn_get_catalog' );
         //alert( _.l( 'error.file_no_api' ) );
      }
      od.data.load_catalog(
         function loadCatalogOk(){
            od.data.get().forEach( function( c ){ od.download.create( c.name ); } );
            od.action.download.refresh();
         },
         function loadCatalogFail(){
            od.action.download.refresh();
         }
      );
   },

   'setup': function act_download_setup () {
   },
   'cleanup': null,

   /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

   'tr': {},

   'get_catalog' : function act_download_get_catalog () {
      od.download.get_catalog( od.action.download.refresh );
   },

   'list_all' : function act_download_list_all () {
      od.download.get().forEach( function act_download_list_all_each ( remote ) {
         remote.get_listing( od.action.download.refresh_func( remote ) );
      } );
   },

   'update_all' : function act_download_update_all () {
      od.download.get().forEach( function act_download_update_all_each ( remote ) {
         if ( remote.added.length || remote.changed.length ) {
            var refresh = od.action.download.refresh_func( remote );
            remote.update_changed( refresh, refresh );
         }
      } );
      _.hide( '#act_download_btn_update' );
   },

   'save' : function act_download_save () {
      var remotes = od.download.get();
      var latch = new _.Latch( remotes.length+1 );
      remotes.forEach( function act_download_save_cat(e) {
         e.save( latch.count_down_function() );
      });
      latch.ondone = function act_download_save_done() {
         od.data.save_catalog();
         _.hide( '#act_download_btn_save' );
      };
      latch.count_down();
   },

   'create_row' : function act_download_create_row( remote ) {
      var local = od.data.get( remote.name );
      var tr = _.create( 'tr', { 'data-name': remote.name } );
      tr.appendChild( _.create( 'td', { 'text': remote.name } ) );
      tr.appendChild( _.create( 'td', { 'text': local ? local.count : '--' } ) ); // 1: Local count
      tr.appendChild( _.create( 'td' ) ); // 2: Remote count
      tr.appendChild( _.create( 'td' ) ); // 3: Added count
      tr.appendChild( _.create( 'td' ) ); // 4: Changed count
      tr.appendChild( _.create( 'td' ) ); // 5: Actions
      _('#act_download_tbl_list tbody')[0].appendChild( tr );
      return this.tr[ remote.name ] = tr;
   },

   'create_button' : function act_download_create_button( command, remote, txt ) {
      var refreshRemote = od.action.download.refresh_func( remote );
      var param;
      switch ( command ) {
          case 'reindex' : 
             param = { 'type' : 'button', 'value' : _.l( txt ), 'onclick' : function act_download_btn_reindex() {
               // TODO: Reindex
             }};
             break;
          case 'delete' :
             param = { 'type' : 'button', 'value' : _.l( txt ), 'onclick' : function act_download_btn_reindex() {
                od.download.delete( remote );
             }};
             break;
          case 'list' : 
             param = { 'type' : 'button', 'value' : _.l( txt ), 'onclick' : function act_download_btn_list() {
                remote.get_listing( refreshRemote );
             }};
             break;
          case 'update_all':
             param = { 'type' : 'button', 'value' : _.l( txt ), 'onclick' : function act_download_btn_update_all() {
                remote.update_all( refreshRemote, refreshRemote );
             }};
             break;
          case 'update':
             param = { 'type' : 'button', 'value' : _.l( txt ), 'onclick' : function act_download_btn_update() {
                remote.update_changed( refreshRemote, refreshRemote );
             }};
             break;
      }
      return _.create( 'input', param );
   },

   'refresh_func' : function act_download_refresh_func ( remote_cat ) {
      return function act_download_refresh_func_callback () {
          od.action.download.refresh( remote_cat );
      };
    },

   'refresh' : function act_download_refresh ( remote_cat ) {
      var action = od.action.download;

      // Find whether there are unlisted (Check all), changed (Get all), Downloading & Dirty (Save all) items
      var unlisted = false, changed = false, downloading = false, dirty = od.download.dirty_catalog;
      od.download.get().forEach( function act_download_refresh_check( remote ) {
         switch ( remote.state ) {
            case "local" :
            case "listing":
            case "absent" :
                break;
            case "unlisted" :
                unlisted = true;
                break;
            case "listed" :
                dirty = dirty || remote.dirty.length > 0;
                changed = changed || ( remote.added.length > 0 || remote.changed.length > 0 );
                break;
            case "downloading":
                downloading = true;
                break;
         }
      });

      // Update specified rows's data and 
      function act_download_refresh_row ( remote ) {
         var tr = action.tr[ remote.name ];
         if ( tr === undefined ) tr = action.create_row( remote );
         var cells = _( tr, 'td' );
         var commands = cells[5];
         var local = od.data.get( remote.name );
         commands.innerHTML = '';
         //var local = od.data.get( remote.name );
         //cells[1].textContent = local ? local.count : '--'; // Local count may change because of load failure or download update
         switch ( remote.state ) {
            case "listing":
            case "downloading":
               break; // Please do not interrupt while working!
            case "absent" :
               cells[2].textContent =  cells[3].textContent =  cells[4].textContent = '--';
               //cells[5].textContent = 'Local'; // TODO: i18n
               // TODO: Reindex
               commands.appendChild( action.create_button( 'delete', remote, 'action.download.btn_delete' ) );
               break;
            case "local" :
               cells[2].textContent =  cells[3].textContent =  cells[4].textContent = '';
               //cells[5].textContent = '';
               // TODO: Reindex
               commands.appendChild( action.create_button( 'delete', remote, 'action.download.btn_delete' ) );
               break;
            case "unlisted" :
               cells[2].textContent =  cells[3].textContent =  cells[4].textContent = '??';
               //cells[5].textContent = 'Unlisted'; // TODO: i18n
               commands.appendChild( action.create_button( 'list', remote, 'action.download.btn_list' ) );
               if ( local ) commands.appendChild( action.create_button( 'delete', remote, 'action.download.btn_delete' ) );
               break;
            case "listed" :
               cells[2].textContent = remote.count;
               cells[3].textContent = remote.added.length;
               cells[4].textContent = remote.changed.length;
               //cells[5].textContent = remote.progress;
               if ( remote.raw.length )
                  commands.appendChild( action.create_button( 'update_all', remote, 'action.download.btn_update_all' ) );
               if ( remote.added.length || remote.changed.length )
                  commands.appendChild( action.create_button( 'update', remote, 'action.download.btn_update_changed' ) );
               if ( local ) {
                  commands.appendChild( action.create_button( 'delete', remote, 'action.download.btn_delete' ) );
                  commands.appendChild( action.create_button( 'list', remote, 'action.download.btn_relist' ) );
               }
               // TODO: Delete, Reindex
               break;
         }
      };

      if ( remote_cat !== undefined ) {
         act_download_refresh_row( remote_cat );
      } else {
        od.download.get().forEach( act_download_refresh_row );
      }

      if ( changed ) {
         od.gui.set( '#act_download_btn_update', _.l( 'action.download.btn_update_changed', null, changed ) );
      }
      _.visible( '#act_download_btn_save', ( ! downloading ) && dirty );
      _.visible( '#act_download_btn_all_list', unlisted );
      _.visible( '#act_download_btn_update', changed );
      _.show('#act_download_tbl_list');
   }
};

})();</script>