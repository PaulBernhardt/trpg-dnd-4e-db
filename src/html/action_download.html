<!--
  - action_download.html
  - Query online compendium and shows what can be downloaded / updated.
  -->
<div id='action_download' data-role='page'>

   <header>
      <a class='i18n' onclick='od.gui.switch_action( od.action.list );'> action.list.link_text </a>
      <h1 class='i18n'>action.download.title</h1>
      <a class='i18n' onclick='od.gui.switch_action( od.action.about )'> action.about.link_text </a>
   </header>

   <p class='i18n'> action.download.paragraph.0 </p>
   <p class='i18n'> action.download.paragraph.1 </p>
   <p>
      <a class='button i18n' id='act_download_btn_get_catalog' onclick='od.action.download.get_catalog()'> action.download.btn_get_catalog </a>
      <a class='button i18n' id='act_download_btn_all_list' onclick='od.action.download.get_all_list()'> action.download.btn_all_list </a>
      <a class='button i18n' id='act_download_btn_update' onclick='od.action.download.update_all()'> action.download.btn_update_changed </a>
      <a class='button i18n' id='act_download_btn_save' onclick='od.action.download.save()'> action.download.btn_save </a>
   </p>
   <table id='act_download_tbl_list'>
      <thead>
         <tr>
            <th class='i18n'> action.download.th_category </th>
            <th class='i18n'> action.download.th_local </th>
            <th class='i18n'> action.download.th_remote </th>
            <th class='i18n'> action.download.th_new </th>
            <th class='i18n'> action.download.th_changed </th>
            <th class='i18n'> action.download.th_status </th>
            <th class='i18n'> action.download.th_commands </th>
         </tr>
      </thead>
      <tbody></tbody>
   </table>
   <!--fieldset id='act_download_lst_status'><legend class='i18n'>action.download.lst_thread</legend></fieldset-->
</div>
<script type='text/javascript'>'use strict';(function action_download_init(){
/*
 * Remote category commands by state:
 *  - local / absent: Reindex | Delete
 *  - unlisted: Check | Reindex | Delete
 *  - listing: (none)
 *  - listed: Recheck | Reindex | Delete | Update All | Update changed
 *  - downloading: Stop
 *  
 * Top buttons: List categories | Check all | Update changed | Stop all | Save | Reindex all
 *  
 * If any remote category has dirty data, save button may be available.
 * If any category is downloading, reindex/delete/save is not available for all cat, since data is being updated.
 * A check will reload listing but will not reset dirty (copied to local) data.
 * Reindex and delete will erase any dirty data.  Both are saved immediately.
 *
 * Workflow:
 *   Load cat -> create remotes (local) -> Get cat -> Create / update remote state (unlisted or absent).
 *   List / Relist : reset ->  (listing) get_listing -> find_changed (listed)
 *   Download -> schedule_download -> get_data -> local.update, add to dirty
 */
od.action.download = {
   'id': 'action_download',

   'initialize': function act_download_init () {
      _.hide( '#act_download_tbl_list, #act_download_btn_all_list, #act_download_btn_update, #act_download_btn_save');
      if ( location.protocol !== 'file:' || ! window.ActiveXObject || ! /\bMSIE (9|\d\d+)\./.test(navigator.userAgent) ) {
         _.hide( '#act_download_btn_get_catalog' );
         //alert( _.l( 'error.file_no_api' ) );
      }
      od.data.load_catalog(
         function loadCatalogOk(){
            od.data.get().forEach( function( c ){ od.download.create( c.name ); } );
            od.action.download.refresh();
         },
         function loadCatalogFail(){
            od.action.download.refresh();
         }
      );
   },

   'setup': function act_download_setup () {
   },
   'cleanup': null,

   /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

   'tr': {},

   'get_catalog' : function act_download_get_catalog () {
      od.download.get_catalog( od.action.download.refresh );
   },

   'get_all_list' : function act_download_all_list () {
      od.download.get().forEach( function( c ) {
         c.get_listing( od.action.download.refresh );
      } );
   },

   'update_all' : function act_download_update_all () {
      var action = od.action.download;
      od.download.get().forEach( function( c ) {
         var changeCount = c.added.length + c.changed.length;
         if ( changeCount )
            od.download.schedule_download( c, [].concat( c.added, c.changed ), action.progress_func( action.tr[ c.name ], changeCount ) );
      } );
      _.hide( '#act_download_btn_update' );
   },

   'save' : function act_download_save () {
      var remotes = od.download.get();
      var latch = new _.Latch( remotes.length+1 );
      remotes.forEach( function act_download_save_cat(e) {
         e.save( latch.count_down_function() );
      });
      latch.ondone = function act_download_save_done() {
         od.data.save_catalog();
         _.hide( '#act_download_btn_save' );
      };
      latch.count_down();
   },

   'progress_func' : function act_download_progress ( tr, total ) {
      _( tr, 'td:last-child' )[0].innerHTML = '';
      var count = 0;
      return function act_download_progress_callback ( ) {
         _( tr, 'td:last-child' )[0].innerHTML = _.l( 'action.download.lbl_progress', null, ++count, total );
         if ( count >= total ) _.show( '#act_download_btn_save' );
         od.action.list.reset();
      };
   },

   'create_row' : function act_download_create_row( remote ) {
      var local = od.data.get( remote.name );
      var tr = _.create( 'tr', { 'data-name': remote.name } );
      tr.appendChild( _.create( 'td', { 'text': remote.name } ) );
      tr.appendChild( _.create( 'td', { 'text': local ? local.count : '--' } ) ); // 1: Local count
      tr.appendChild( _.create( 'td' ) ); // 2: Remote count
      tr.appendChild( _.create( 'td' ) ); // 3: Added count
      tr.appendChild( _.create( 'td' ) ); // 4: Changed count
      tr.appendChild( _.create( 'td' ) ); // 5: Status
      tr.appendChild( _.create( 'td' ) ); // 6: Actions
      _('#act_download_tbl_list tbody')[0].appendChild( tr );
      od.action.download.tr[ remote.name ] = tr;
      return tr;
   },

   'refresh' : function act_download_refresh () {
      var action = od.action.download;
      var unlisted = 0, changed = 0, dirty = 0;
      od.download.get().forEach( function( remote ) {
         var tr = action.tr[ remote.name ];
         if ( tr === undefined ) tr = action.create_row( remote );
         var cells = _( tr, 'td' );
         var commands = cells[6];
         commands.innerHTML = '';
         switch ( remote.state ) {
            case "listing":
            case "downloading":
               break; // Please do not interrupt while working!
            case "absent" :
               cells[2].textContent =  cells[3].textContent =  cells[4].textContent = '--';
               cells[5].textContent = 'Local'; // TODO: i18n
               // TODO: Delete, Reindex
               break;
            case "local" :
               cells[2].textContent =  cells[3].textContent =  cells[4].textContent = '??';
               cells[5].textContent = '';
               // TODO: Delete, Reindex
               break;
            case "unlisted" :
               cells[2].textContent =  cells[3].textContent =  cells[4].textContent = '??';
               cells[5].textContent = 'Unlisted'; // TODO: i18n
               commands.appendChild( _.create( 'input', { 'type'  : 'button', 'value' : _.l('action.download.btn_list'),
                  'onclick' : function act_download_category_list() {
                     remote.get_listing( od.action.download.refresh );
                  }
               } ) );
               break;
            case "listed" :
               var changeCount = remote.added.length + remote.changed.length;
               changed += changeCount;
               cells[2].textContent = remote.count;
               cells[3].textContent = remote.added.length;
               cells[4].textContent = remote.changed.length;
               cells[5].textContent = remote.progress;
               if ( changeCount ) {
                  commands.appendChild( _.create( 'input', { 'type'  : 'button', 'value' : _.l('action.download.btn_update_all' ),
                     'onclick' : function act_download_category_list() {
                        od.download.schedule_download( remote, _.col( remote.raw ), od.action.download.progress_func( tr, remote.raw.length ) );
                     }
                  } ) );
                  commands.appendChild( _.create( 'input', { 'type'  : 'button', 'value' : _.l('action.download.btn_update_changed', null, changeCount ),
                     'onclick' : function act_download_category_list() {
                        od.download.schedule_download( remote, [].concat( remote.added, remote.changed ), od.action.download.progress_func( tr, changeCount ) );
                     }
                  } ) );
               }
            default:
               cells[2].textContent =  cells[3].textContent =  cells[4].textContent = '??';
               cells[5].textContent = remote.state;
         }
         dirty += remote.dirty.length;
      });
      if ( changed ) {
         _( '#act_download_btn_update' )[0].innerHTML = _.l( 'action.download.btn_update_changed', null, changed );
      }
      _.visible( '#act_download_btn_save', dirty );
      _.visible( '#act_download_btn_all_list', unlisted );
      _.visible( '#act_download_btn_update', changed );
      _.show('#act_download_tbl_list');
   }
};

})();</script>