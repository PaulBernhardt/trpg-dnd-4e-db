<!--
  - action_list.html
  - List and search downloaded entries
  -->
<div id='action_list' data-role='page'>
   <style scoped>
      /* Search buttons */
      #act_list_tbl_search {
         width: 100%;
         max-width: 320px;
         border-spacing: 0;
      }
      #act_list_tbl_search button {
         border-radius: 0;
      }
      #act_list_tbl_search td:first-child button {
         width: 50%;
         margin: 0;
      }
      #act_list_tbl_search td+td {
         width: 30px;
      }
      /* Category list */
      #act_list_pnl_category a {
         display: block;
         float: left;
         width: 100%;
         border: 1px ridge #888;
         padding: 5px;
         max-width: 320px;
      }
      #act_list_pnl_category a span {
         float: right;
      }
      #act_list_pnl_list {
         clear: left;
      }
   </style>

   <header>
      <a class='i18n' id='act_list_btn_update' onclick='od.gui.switch_action( od.action.download )'> action.download.link_text </a>
      <h1 class='i18n'>action.list.title</h1>
      <a class='i18n' onclick='od.gui.switch_action( od.action.about )'> action.about.link_text </a>
   </header>

   <div id='act_list_pnl_search'>
      <input type='search' id='act_list_txt_search' class='fullw' autocomplete autofocus />
      <br/>
      <table id="act_list_tbl_search"><tr>
         <td
            ><button class="button i18n" onclick="od.action.list.txt_search('name');"> action.list.bth_search_name </button
            ><button class="button i18n" onclick="od.action.list.txt_search('full');"> action.list.bth_search_body </button
         ></td>
         <td
            ><button class="button i18n" onclick=""> action.list.bth_search_advanced </button
         ></td>
      </table>

      <div id='act_list_pnl_category'></div>

      <div id='act_list_pnl_list'>
         <table class='fullw'></table>
      </div>
   </div>
</div>

<script type='text/javascript'>'use strict';(function action_list_init(){
od.action.list = {
   'id': 'action_list',

   'initialize' : function act_list_init() {
      _('#act_list_txt_search')[0].setAttribute( 'placeholder', _.l( 'action.list.txt_search_placeholder' ) );
      //_.visible( '#act_list_btn_update', od.config.show_download ); // Download page should be available all times, if just for explaining 'Why you must download with that browser'.
      this.show_category();
   },

   'setup': function act_list_setup () {
      _( '#act_list_txt_search' )[0].focus();
      if ( _('#act_list_pnl_category a').length <= 0 ) this.show_category();
   },

   'cleanup': null,

   /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
   '_last_search_type' : 'name',

   'search_timeout' : 0,

   'category' : null,
   'columns' : [],
   'data' : [],
   'highlights' : [],

   'txt_search' : function act_list_txt_search ( search_type ) {
      var action_list = od.action.list;
      if ( search_type === undefined ) {
         search_type = action_list._last_search_type;
      } else {
         action_list._last_search_type = search_type;
      }
      od.search.search({
         'category': action_list.get_search_category(),
         'term': action_list.get_search_term(),
         'search_body': search_type === 'full',
         'ondone'  : action_list.show_list
      });
   },

   'get_search_category' : function act_list_get_search_category () {
      var cat = od.action.list.category;
      return cat ? cat : null;
   },

   'get_search_term' : function act_list_get_search_term () {
      return _( '#act_list_txt_search' )[0].value;
   },

   'a_category' : function act_list_a_category ( cat ) {
      var action_list = od.action.list;
      cat = action_list.category = cat ? od.data.get( cat ) : null;
      if ( action_list.get_search_term() !== '' ) {
         action_list.txt_search();
      } else {
         od.search.list_category( cat, action_list.show_list );
      }
   },

   'show_category' : function act_list_show_category() {
      od.action.list.category = null;
      od.data.load_catalog( function act_list_show_category_load() {
         _.show( '#act_list_pnl_category' );
         var div = _('#act_list_pnl_category')[0];
         var total = 0;
         div.innerHTML = '';
         // Sort and create each category
         var list = od.data.get();
         list.sort( function (a,b){ return a.name > b.name ? 1 : ( a.name < b.name ? -1 : 0); } );
         list.forEach(function(cat){
            var a = _.create( 'a', { 'text' : cat.title, 'onclick' : function (){ od.action.list.a_category( cat.name ); } } );
            a.appendChild( _.create( 'span', cat.count ) );
            div.appendChild( a );
            total += cat.count;
         });
         // Prepend all category
         var all = _.create( 'a', { 'text' : _.l( 'action.list.a_all' ), 'onclick' : od.action.list.a_category } );
         all.appendChild( _.create( 'span', total ) );
         div.insertBefore( all, div.firstChild );
      }, function act_list_show_category_error() {
         od.gui.switch_action( od.action.download );
      });
   },

   'show_list' : function act_list_show_list( col, data, highlight ) {
      var table = _( '#act_list_pnl_list table' )[0];
      var action_list = od.action.list;
      table.parentNode.removeChild( table );
      table = _.create('table');
      //table.innerHTML = ''; // Remove a table is 13% faster then clearing it, but both spend major time when list is big
      var head = _.create( 'thead' );
      var body = _.create( 'tbody' );
      table.appendChild( head );
      table.appendChild( body );
      action_list.columns = col;
      var cl = col.length;
      var idField = col[ 0 ];
      var i, l;
      for ( i = 1 ; i < cl ; i++ ) {
         head.appendChild( _.create( 'th', {
            'text': _.l( 'data.field.' + col[i], col[i] ),
            'onclick': function(){ alert('sorting unimplemented (target M3)'); }
         } ) );
      }
      if ( ! data || data.length <= 0 ) {
         _.time( 'Search yielded empty results' );
         _( '#act_list_pnl_list' )[0].appendChild( table );
         return body.appendChild( _.create( 'td', { 'rowspan' : cl, 'align' : 'center', 'etxt' : _.l( 'action.list.lbl_no_result' ) } ) );
      }
      _.time( 'Listing ' + data.length + ' results (' + col + ')' );
      action_list.data = data;
      for ( i = 0, l = data.length ; i < l ; i++ ) {
         var line = data[i];
         if ( line ) {
            // Create row.  Creating it ourself is about 18% faster then _.create.
            var row = document.createElement( 'tr' );
            row.addEventListener( 'click', action_list.row_click );
            row.setAttribute( 'data-id', line[ idField ] );
            if ( action_list.category === null ) row.setAttribute( 'data-category', line._category.name );
            /* Building row by string is not supported by IE http://www.ericvasilik.com/2006/07/code-karma.html */
            for ( var j = 1 ; j < cl ; j++ ) {
               var td = document.createElement('td');
               var d = line[ col[ j ] ];
               if ( d ) td.textContent = d.text ? d.text : d;
               row.appendChild( td );
            }
            body.appendChild( row );
         }
      }
      _( '#act_list_pnl_list' )[0].appendChild( table );
      _.time('Listed ' + data.length + ' results.' );
    },

   'row_click' : function() {
       var list = od.action.list;
       var cat = od.action.list.category;
       if ( ! cat ) cat = this.getAttribute( 'data-category' );
       var id = this.getAttribute('data-id');
       od.action.view.show_data( this.querySelector('td').textContent, [[cat, id]] );
   }
};

})();</script>