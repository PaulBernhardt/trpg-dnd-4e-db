<!--                                                                            ex: softtabstop=3 shiftwidth=3 tabstop=3 expandtab
  - action_list.html
  - List and search downloaded entries
  -->
<div id='action_list' data-role='page'>
   <header>
      <button class='i18n' id='act_list_btn_update' onclick='od.gui.goto("update")'> action.update.link_text </button>
      <h1 class='i18n'>action.list.title</h1>
      <button class='i18n' onclick='od.gui.goto("about")'> action.about.link_text </button>
   </header>

   <style scoped>
      #act_list_pnl_term {
         margin-bottom: 5px;
      }
      /* Search buttons */
      #act_list_tbl_search {
         width: 100%;
         border-spacing: 0;
      }
      #act_list_tbl_search button {
         border-radius: 0;
         font-weight: bold;
      }
      #act_list_tbl_search td:first-child button {
         width: 50%;
         margin: 0;
      }
      #act_list_tbl_search td+td {
         width: 30px;
      }
      /* Category list */
      #act_list_pnl_category {
         clear: left;
      }
      #act_list_pnl_category button {
         display: block;
         float: left;
         width: 100%;
         height: 39px;
         border: 1px outset #888;
         padding: 2px 5px;
         max-width: 360px;
         font-size: 125%;
         line-height: 33px;
      }
      #act_list_pnl_category button * {
         float: left;
         margin-right: 5px;
      }
      #act_list_pnl_category button var {
         float: right;
         font-weight: normal;
      }
      /* Result list */
      #act_list_pnl_list {
         clear: left;
         font-size: 120%;
      }
      #act_list_pnl_list td {
         padding: 0 5px;
      }
      #act_list_pnl_list tbody tr:hover {
         background: gold;
         cursor: pointer;
         color: red;
      }
      /* Big screen: Move search buttons to the right of search box */
      @media (min-width: 768px) {
         #act_list_pnl_term { margin-right: -300px; padding-right: 300px; float: left; width: 100%; }
         #act_list_txt_search { font-size: 120%; }
         #act_list_tbl_search { width: 300px; float: right; }
      }
      @media (min-width: 910px) {
         #act_list_pnl_category button { max-width: 300px; }
      }
      /* Small screen: Show only selected cat */
      @media (max-width: 889px) {
         #act_list_pnl_category.active button { display: none; }
         #act_list_pnl_category.active button.active { display: block; }
      }
   </style>

   <div id='act_list_pnl_search'>
      <div id="act_list_pnl_term">
         <input type='search' id='act_list_txt_search' onkeydown="od.action.list.txt_search_down(event)" class='fullw' autocomplete autofocus />
      </div>
      <table id="act_list_tbl_search"><tr><td
         ><button id='act_list_btn_search_name' class="button activable i18n active" onclick="od.action.list.search('name');"> action.list.bth_search_name </button
         ><button id='act_list_btn_search_full' class="button activable i18n" onclick="od.action.list.search('full');"> action.list.bth_search_body </button
      ></td><td
         ><button class="button i18n" onclick=""> action.list.bth_search_advanced </button
      ></td></table>

      <div id='act_list_pnl_category'></div>

      <div id='act_list_pnl_list'>
         <table class='fullw'><thead><tr><td class="i18n"> action.list.lbl_select_cat </td><tr></thead></table>
      </div>
   </div>
</div>

<script type='text/javascript'>'use strict';(function action_list_init(){
od.action.list = {
   'url' : /^(list|namesearch|fullsearch|advsearch)\b/,
   'url_current' : 'list',

   'initialize' : function act_list_init () {
      _('#act_list_txt_search')[0].setAttribute( 'placeholder', _.l( 'action.list.txt_search_placeholder' ) );
      //_.visible( '#act_list_btn_update', od.config.show_download ); // Download page should be available all times, if just for explaining 'Why you must download with that browser'.
      this.build_category();
   },

   'setup': function act_list_setup () {
      _( '#act_list_txt_search' )[0].focus();
   },

   'cleanup': null,

   /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
   'last_search_type' : 'name',
   'category' : undefined, // Active category.  undefined = None.  "" = All.
   'category_dom' : {},   // Category button list.
   'sort_field' : undefined, // Field currently being sorted. Empty means use natural sort.
   'sort_asc' : true,   // Whether current sort is ascending or decending.

   'counts' : null, // Current result count object.
   'total_count' : 0,

   // Current category's search result
   'columns' : [],
   'data' : [],  // Current result list (unsorted). Sorting will use this list instead of reapplying search.
   'highlights' : [],

   'txt_search_down' : function act_list_txt_search_down ( evt ) {
      if ( evt.keyCode === 13 && ! evt.altKey && ! evt.ctrlKey && !evt.metaKey ) this.search();
   },

   'set_search_category' : function act_list_set_search_category ( cat ) {
      od.action.list.category = cat;
      _.removeClass( '#act_list_pnl_category, #act_list_pnl_category .activable.active' );
      _.addClass( '#act_list_pnl_category', 'active' );
      _.addClass( od.action.list.category_dom[ cat ? cat.name : "" ], 'active' );
   },

   'get_search_category' : function act_list_get_search_category () {
      return od.action.list.category;
   },

   'get_search_term' : function act_list_get_search_term () {
      return _( '#act_list_txt_search' )[0].value;
   },

   /**
    * Event handler for category buttons
    *
    * @param {String} cat Name of category. Empty = all categories.
    */
   'a_category' : function act_list_a_category ( cat ) {
      var action_list = od.action.list;
      if ( document.body.clientWidth <= 980 && _.hasClass( '#act_list_pnl_category', 'active') ) {
         // Hide results and show category list
         _.hide( '#act_list_pnl_list' );
         _.removeClass( '#act_list_pnl_category, #act_list_pnl_category .activable.active' );
         return;
      }
      action_list.set_search_category( cat ? od.data.get( cat ) : "" );
      action_list.search();
      _( '#act_list_txt_search' )[0].focus();
   },

   /**
    * Called by search button click event or search field key event to do a search
    *
    * @param {String} search_type Type of search, may be undefined, 'full', or 'name'.
    */
   'search' : function act_list_search ( search_type ) {
      var action_list = od.action.list;
      if ( search_type !== undefined ) { // Pressed search button; update state.
         _.removeClass( '#act_list_tbl_search .active' );
         _.addClass( '#act_list_btn_search_' + search_type, 'active' );
         action_list.last_search_type = search_type;
      }
      if ( action_list.get_search_term() === '' ) {
         od.search.list_category( action_list.get_search_category(), action_list.build_list );
      } else {
         var cat = action_list.get_search_category();
         if ( search_type === undefined ) { // e.g. Pressing Enter in search box or clicked filter button.
            search_type = action_list.last_search_type;
         }
         if ( cat !== undefined ) {
            od.search.search( {
               'category': cat,
               'term': action_list.get_search_term(),
               'search_body': search_type === 'full',
               'ondone'  : action_list.build_list
            } );
         }
      }
      _( '#act_list_txt_search' )[0].focus();
   },

   /** Called after category is loaded to build category buttons */
   'build_category' : function act_list_build_category () {
      // Category order and colour is defined at od.config in config.js
      var action_list = od.action.list;
      action_list.counts = null;
      action_list.category = undefined;
      action_list.category_dom = {};

      function create_category_button( div, cat, colour, title, name, count ) {
         if ( title === undefined ) {
            title = cat.title;
            name = cat.name;
            count = cat.count;
         }
         var a = _.create( 'button', {
            'class': 'activable',
            'style': 'background-color:'+colour,
            'onclick' : function create_category_button_click () { action_list.a_category( name ); }
         } );
         a.appendChild( _.create( 'span', { 'class' : 'rpg ' + name } ) );
         a.appendChild( _.create( 'b', title ) );
         a.appendChild( _.create( 'var', count ) );
         div.appendChild( a );
         action_list.category_dom[ name ] = a;
         return count;
      }

      od.data.load_catalog( function act_list_build_category_load () {
         var div = _( '#act_list_pnl_category' )[ 0 ];
         var total = 0;
         div.innerHTML = '';
         // Sort and create each category
         var list = od.data.get(), colour = "";
         od.config.category_order.forEach( function act_list_build_category_create ( name ) {
            if ( name.charAt(0) === '#' ) {
               // Set button colour
               colour = name.substr( 1 );

            } else if ( name === '{All}' ) {
               // Create all category button
               create_category_button( div, null, colour, _.l( 'action.list.a_all' ), "", 0 );

            } else {
               // Create normal category button
               var cat = od.data.get( name );
               if ( cat ) {
                  total += create_category_button( div, cat, colour );
                  list.splice( list.indexOf( cat ), 1 );
               }
            }
         } );
         // Create unexpected category button
         for ( var i = 0, l = list.length ; i < l ; i++ ) {
            total += create_category_button( div, list[i], colour );
         }
         action_list.total_count = total;
         _( action_list.category_dom[''], 'var' )[0].textContent = total;
         _.show( div );
      }, function act_list_build_category_error () {
         od.gui.goto( "update" );
      });
   },

   /** Callback for search / list, to display the results */
   'build_list' : function act_list_build_list ( col, data, counts, highlight ) {
      var action_list = od.action.list, cl = col.length;
      action_list.columns = col;
      action_list.data = data;
      action_list.highlights = highlight;

      // Remove old table and create a new one.
      var table = _( '#act_list_pnl_list table' )[0];
      table.parentNode.removeChild( table ); // Remove a table is 13% faster then clearing it, but both is slow when list is big
      table = _.create('table');
      var head = _.create( 'thead' );
      table.appendChild( head );

      // Show result counts
      if ( action_list.counts !== counts ) {
         if ( counts ) {
            od.data.get().forEach( function act_list_show_count_each ( cat ) {
               var txt, dom = action_list.category_dom[ cat.name ];
               if ( counts ) {
                  var c = counts[ cat.name ];
                  txt = _.l( 'action.list.lbl_count', null, c === undefined ? '--' : ~~c, cat.count );
               } else {
                  txt = cat.count;
               }
               _( dom, 'var' )[ 0 ].textContent = txt;
            } );
            var c = counts[ '' ], dom = action_list.category_dom[ '' ];
            _( dom, 'var' )[ 0 ].textContent = _.l( 'action.list.lbl_count', null, c === undefined ? '--' : ~~c, action_list.total_count );
         } else {
            _( dom, 'var' )[ 0 ].textContent = action_list.total_count;
         }
         action_list.counts = counts;
      }

      // Headers
      for ( var i = 1 ; i < cl ; i++ ) {
         // Data field column
         var th = _.create( 'th' ), label = _.l( 'data.field.' + col[i], col[i] );
         th.appendChild( _.create( 'input', { 'type': 'search', 'class' : 'list_filter', 'placeholder': label } ) );
         th.appendChild( _.create( 'br' ) );
         th.appendChild( _.create( 'span', {
            'text': label,
            'onclick': function act_list_header_click(){
               action_list.sort_asc = action_list.sort_field === i ? ! action_list.sort_asc : true;
               action_list.sort_field = i;
               alert('Sorting unimplemented');
            }
         } ) );
         head.appendChild( th );
      }
      // Action column
      var th = _.create( 'th' );
      th.appendChild( _.create( 'input', { 'type': 'button', 'value': _.l( 'action.list.btn_clear_filter', '×' ), onclick: function () {
         _.set( '.list_filter', 'value', '' );
         action_list.search();
      } } ) );
      th.appendChild( _.create( 'input', { 'type': 'checkbox', 'title': _.l( 'action.list.chk_all', 'Check/Uncheck all' ), onchange: function () {
         this.indeterminate = false;
         var checked = this.checked;
         _.set( '.list_sel', 'checked', checked );
      } } ) );
      th.appendChild( _.create( 'br' ) );
      th.appendChild( _.create( 'input', { 'type': 'button', 'value': _.l( 'action.list.btn_filter', 'Filter' ), 'onclick': action_list.search } ) );
      head.appendChild( th );

      action_list.show_list( table );
      table.addEventListener( 'click', action_list.table_click );
      _.show( '#act_list_pnl_list' )[0].appendChild( table );
   },

   /** List the current result, e.g. after changing sorting. */
   'show_list' : function act_list_show_list ( table ) {
      var action_list = od.action.list;
      var data = action_list.data, col = action_list.columns;
      var cl = col.length, idField = col[ 0 ];

      if ( ! table ) table = _( '#act_list_pnl_list table' )[0];
      var body = _( table, 'tbody' );
      if ( body.length ) body[0].parentNode.removeChild( body[0] );
      body = _.create( 'tbody' );

      // Show data
      if ( ! data || data.length <= 0 ) {
         return body.appendChild( _.create( 'td', { 'rowspan' : cl, 'align' : 'center', 'text' : _.l( 'action.list.lbl_no_result' ) } ) );
      }
      _.time( 'Listing ' + data.length + ' results (' + col + ')' );
      for ( var i = 0, l = data.length ; i < l ; i++ ) {
         var line = data[i];
         if ( line ) { // Create row; intensive (up to tens of thousands).  Creating it by DOM is about 18% faster then _.create.
            var row = document.createElement( 'tr' );
            row.setAttribute( 'data-id', line[ idField ] );
            if ( action_list.category === null ) row.setAttribute( 'data-category', line._category.name );
            /* Building row by string is not supported by IE http://www.ericvasilik.com/2006/07/code-karma.html */// TODO: Reconsider and retest speed!
            for ( var j = 1 ; j < cl ; j++ ) { // Note: VERY intensive loop - hundred thousands if user click 'all'.
               var td = document.createElement('td');
               var d = line[ col[ j ] ];
               if ( d ) td.textContent = d.text ? d.text : d;
               row.appendChild( td );
            }
            var td = document.createElement('td');
            td.innerHTML = '<input type="checkbox" class="list_sel">';
            row.appendChild( td );
            body.appendChild( row );
         }
      }
      table.appendChild( body );

      _.time( 'Listed ' + data.length + ' results.' );
   },

   /**
    * When user clicked in the result table,
    * we try to detect the clicked row and do some preparation before showing the entry.
    *
    * This is much more efficient then adding an event handler to every row.
    *
    * @param {Event} evt Event object.
    */
   'table_click' : function act_list_table_click ( evt ) {
      // If user clicked on check box, ignore.
      if ( ! evt || evt.target.tagName === 'INPUT' ) return;

      // Find the row that user clicked.
      var e = evt.target;
      while ( e && e.tagName !== 'TR' ) e = e.parentNode;
      if ( ! e ) return;

      // Find category and id and trigger navigation
      var list = od.action.list;
      var cat = od.action.list.category;
      if ( ! cat ) cat = od.data.get( e.getAttribute( 'data-category' ) );
      var id = od.config.id( e.getAttribute('data-id') );
      od.gui.goto( "view=" + encodeURIComponent( cat.name + '.' +  id ) );
   }
};

})();</script>