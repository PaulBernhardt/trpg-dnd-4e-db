<!--                                                                            ex: softtabstop=3 shiftwidth=3 tabstop=3 expandtab
  - action_list.html
  - List and search downloaded entries
  -->
<section id='action_list'>
   <style scoped>
      #act_list_pnl_term {
         margin-bottom: 5px;
      }
      #act_list_txt_search {
         width: 100%;
      }
      /* Search buttons */
      #act_list_tbl_search {
         width: 100%;
         border-spacing: 0;
      }
      #act_list_tbl_search button {
         border-radius: 0;
         font-weight: bold;
      }
      #act_list_tbl_search td:first-child button {
         width: 50%;
         margin: 0;
      }
      #act_list_tbl_search td+td {
         width: 30px;
      }
      /* Category list */
      #act_list_pnl_category {
         clear: left;
      }
      #act_list_pnl_category button {
         display: block;
         float: left;
         width: 100%;
         height: 39px;
         border: 1px outset #888;
         padding: 2px 5px;
         max-width: 360px;
         font-size: 125%;
         line-height: 33px;
      }
      #act_list_pnl_category button * {
         float: left;
         margin-right: 5px;
      }
      #act_list_pnl_category button var {
         float: right;
         font-weight: normal;
      }
      /* Result list */
      #act_list_lbl_filter {
         clear: left;
         padding-top: 10px;
      }
      #action_list input.txt_filter {
         color: red;
         font-weight: bold;
      }
      #action_list input.txt_filter::-webkit-input-placeholder,
      #action_list input.txt_filter::-moz-placeholder,
      #action_list input.txt_filter::-ms-input-placeholder {
         color: black;
         font-weight: bold;
      }
      #act_list_pnl_list {
         clear: left;
         font-size: 120%;
      }
      #act_list_pnl_list th {
         white-space: nowrap;
      }
      #act_list_pnl_list th .button {
         padding: 0 5px;
      }
      #act_list_pnl_list td {
         padding: 0 5px;
      }
      #act_list_pnl_list tbody tr:hover {
         background: gold;
         cursor: pointer;
         color: red;
      }
      /* Big screen: Move search buttons to the right of search box */
      @media (min-width: 768px) {
         #act_list_pnl_term { margin-right: -300px; padding-right: 300px; float: left; width: 100%; }
         #act_list_txt_search { font-size: 120%; }
         #act_list_tbl_search { width: 300px; float: right; }
      }
      @media (min-width: 910px) {
         #act_list_pnl_category button { max-width: 300px; }
      }
      /* Small screen: Show only selected cat */
      @media (max-width: 889px) {
         #act_list_pnl_category.active button { display: none; }
         #act_list_pnl_category.active button[aria-pressed="true"] { display: block; }
      }
   </style>

   <div id="act_list_pnl_term" role="search">
      <input type='search' id='act_list_txt_search' onkeydown="od.action.list.txt_search_down(event)" accesskey='s' autocomplete />
   </div>
   <table id="act_list_tbl_search" summary=""><tr><td
      ><button id='act_list_btn_search_name' class="button pressable i18n" onclick="od.action.list.search('name');" accesskey='n'> action.list.btn_search_name </button
      ><button id='act_list_btn_search_full' class="button pressable i18n" onclick="od.action.list.search('full');" accesskey='f'> action.list.btn_search_body </button
   ></td></table>

   <div id='act_list_pnl_category' role="tablist"></div>

   <div>
      <div id='act_list_lbl_filter'></div>
      <div id='act_list_pnl_list'></div>
   </div>

   <header role="navigation">
      <button class='i18n' id='act_list_btn_update' onclick='od.gui.go("update")'> action.update.link_text </button>
      <h1 class='i18n'>action.list.title</h1>
      <button class='i18n btn_non_top' onclick='od.gui.go("about")'> action.about.link_text </button>
      <a class='i18n button btn_top' href='#top'> gui.top </a>
   </header>

</section>

<script type='text/javascript'>'use strict';(function action_list_init(){
od.action.list = {
   'url' : /^list\b/,
   'url_current' : 'list',

   'initialize' : function act_list_init () {
      // Set initial search state (e.g. button pressed status)
      od.action.list.search( od.action.list.search_type );
   },

   "l10n" : function act_list_l10n() {
      var action = od.action.list, data = od.data;
      _.attr( '#act_list_txt_search', 'placeholder', _.l( 'action.list.txt_search_' + action.search_type + '_placeholder' ) );
      for ( var name in action.category_dom ) {
         _.attr( _( action.category_dom[ name ], 'b' ), 'text', name ? data.get( name ).getTitle() : _.l( 'action.list.a_all' ) );
      }
   },

   'setup': function act_list_setup () {
      if ( _( '#act_list_pnl_category button' ).length <= 0 )
         this.build_category( od.action.list.parse_action_id );
      else
         od.data.load_catalog( od.action.list.parse_action_id );
   },

   /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
   'search_type' : 'name', // Either 'name' or 'full'
   'category' : undefined, // Active category.  undefined = None.  "" = All.
   'category_dom' : {},   // Category button list.
   'sort_field' : undefined, // Field currently being sorted. Empty means use natural sort.
   'sort_asc' : true,   // Whether current sort is ascending or decending.

   'total_count' : 0,

   // Current category's search result
   'columns' : [],
   'data' : [],  // Current result list (unsorted & unfiltered). Sorting will use this list instead of reapplying search.

   'txt_search_down' : function act_list_txt_search_down ( evt ) {
      if ( evt.keyCode === 13 && ! evt.altKey && ! evt.ctrlKey && !evt.metaKey ) {
         // If nothing is selected, assume a full catalog search
         if ( this.get_search_category() === undefined ) this.set_search_category( "" );
         this.search();
      }
   },

   'txt_filter_input' : function act_list_txt_filter_input ( evt ) {
      if ( act_list_txt_filter_input.timer ) clearTimeout( act_list_txt_filter_input.timer );
      act_list_txt_filter_input.timer = setTimeout( od.action.list.show_list, 300 );
   },

   /**
    * Event handler for category buttons
    *
    * @param {String} cat Name of category. Empty = all categories.
    */
   'a_category' : function act_list_a_category ( cat ) {
      var action = od.action.list;
      if ( document.body.clientWidth <= 980 && _.hasClass( '#act_list_pnl_category', 'active') ) {
         // Hide results and show category list
         _.hide( '#act_list_pnl_list' );
         _.removeClass( '#act_list_pnl_category.active' );
         _.attr( '#act_list_pnl_category .pressable', 'aria-pressed', 'false' );
         return;
      }
      action.set_search_category( cat ? od.data.get( cat ) : "" );
      action.search();
      _( '#act_list_txt_search' )[0].focus();
   },

   /**
    * When user clicked in the result table,
    * we try to detect the clicked row and do some preparation before showing the entry.
    *
    * This is much more efficient then adding an event handler to every row.
    *
    * @param {Event} evt Event object.
    */
   'table_click' : function act_list_table_click ( evt ) {
      // If user clicked on check box, ignore.
      if ( ! evt || evt.target.tagName === 'INPUT' ) return;

      // Find the row that user clicked.
      var e = evt.target;
      while ( e && e.tagName !== 'TR' ) e = e.parentNode;
      if ( ! e ) return;

      // Find category and id and trigger navigation
      var cat = od.action.list.category;
      if ( ! cat ) cat = od.data.get( e.getAttribute( 'data-category' ) );
      var id = od.config.id( e.getAttribute('data-id') );
      od.gui.go( "view=" + encodeURIComponent( cat.name + '.' +  id ) );
   },

   'set_search_category' : function act_list_set_search_category ( cat ) {
      od.action.list.category = cat;
      _.removeClass( '#act_list_pnl_category.active' );
      _.attr( '#act_list_pnl_category .pressable', 'aria-pressed', 'false' );
      if ( cat !== undefined ) {
         _.addClass( '#act_list_pnl_category', 'active' );
         _.attr( od.action.list.category_dom[ cat ? cat.name : "" ], 'aria-pressed', 'true' );
      }
   },

   /*************************************************************************/

   'get_search_category' : function act_list_get_search_category () {
      return od.action.list.category;
   },

   'get_search_term' : function act_list_get_search_term () {
      return _( '#act_list_txt_search' )[0].value;
   },

   'update_action_id' : function act_list_get_action_id () {
      var action = od.action.list, term = action.get_search_term();
      var id = 'list.' + action.search_type;
      if ( action.category ) id += '.' + encodeURIComponent( action.category.name );
      else if ( action.category !== undefined ) id += '.All';
      if ( term ) id += '=' + encodeURIComponent( term );
      if ( action.sort_field ) {
         id += "&sort=" + encodeURIComponent( action.sort_field );
         if ( ! action.sort_asc )
            id += "&reverse=1";
      }
      action.url_current = id;
      od.gui.pushState( id );
   },

   'parse_action_id' : function act_list_parse_action_id () {
      // TODO: Add error handling when parsed info is incorrect
      var id = od.gui.act_id, action_list = od.action.list;
      var parts = id.match( /^list(?:\.(name|full)?\.([^.=]+)?)?(=[^&]+)?(?:&sort=([^&]+)(&reverse=1)?)?(.*)$/ );
      if ( parts ) {
         if ( parts[2] ) {
            action_list.set_search_category( parts[2] === 'All' ? "" : od.data.get( parts[2] ) );
         } else {
            action_list.set_search_category( undefined );
         }
         _( '#act_list_txt_search' )[0].value = parts[3] ? decodeURIComponent( parts[3].substr(1) ) : "";
         action_list.sort_field = parts[4] ? parts[4] : undefined;
         action_list.sort_asc = !!parts[5];
         action_list.search( parts[1] );
      }
   },

   /**
    * Called by search button click event or search field key event to do a search
    *
    * @param {String} search_type Type of search, may be undefined, 'full', or 'name'.
    */
   'search' : function act_list_search ( search_type ) {
      var action = od.action.list;
      if ( search_type !== undefined ) { // Pressed search button; update state.
         _.attr( '#act_list_tbl_search button', 'aria-pressed', 'false' );
         _.attr( '#act_list_btn_search_' + search_type, 'aria-pressed', 'true' );
         action.search_type = search_type;
         action.l10n();
      }
      var cat = action.get_search_category();
      if ( cat !== undefined ) {
         action.update_action_id();
         if ( action.get_search_term() === '' ) {
            od.search.list_category( action.get_search_category(), action.build_list );
         } else {
            if ( search_type === undefined ) { // e.g. Pressing Enter in search box.
               search_type = action.search_type;
            }
            od.search.search( {
               'category': cat,
               'term': action.get_search_term(),
               'type': search_type,
               'ondone'  : action.build_list
            } );
         }
      }
      _( '#act_list_txt_search' )[0].focus();
   },

   'update_counts' : function act_list_update_counts ( counts ) {
      var total = 0, dom = od.action.list.category_dom;
      // Update each category's count
      od.data.get().forEach( function act_list_show_count_each ( cat ) {
         var txt = cat.count;
         if ( counts ) {
            var c = counts[ cat.name ];
            txt = _.l( 'action.list.lbl_count', '%1/%2', c === undefined ? '--' : ~~c, cat.count );
         }
         _.attr( _( dom[ cat.name ], 'var' ), 'text', txt );
         total += cat.count;
      } );
      // Update total count
      var txt = total;
      if ( counts ) {
         var c = counts[ '' ];
         txt = _.l( 'action.list.lbl_count', '%1/%2', c === undefined ? '--' : ~~c, total );
      }
      _.attr( _( dom[ '' ], 'var' ), 'text', txt );
   },

   /** Called after category is loaded to build category buttons */
   'build_category' : function act_list_build_category ( ondone ) {
      // Category order and colour is defined at od.config in config.js
      var action = od.action.list;
      action.category = undefined;
      action.category_dom = {};

      function create_category_button ( div, cat, colour ) {
         var title, name, count;
         if ( cat ) {
            name = cat.name;
            count = cat.count;
         } else {
            // All categories
            name = "";
            count = 0;
         }
         var a = _.create( 'button', {
            'class': 'pressable',
            'aria-pressed' : 'false',
            'style': 'background-color:'+colour,
            'role' : 'tab',
            'onclick' : function create_category_button_click () { action.a_category( name ); }
         } );
         a.appendChild( _.create( 'span', { 'class' : 'rpg ' + name } ) );
         a.appendChild( _.create( 'b', name ) );
         a.appendChild( _.create( 'var', count ) );
         div.appendChild( a );
         action.category_dom[ name ] = a;
      }

      od.data.load_catalog( function act_list_build_category_load () {
         var div = _( '#act_list_pnl_category' )[ 0 ];
         div.innerHTML = '';
         // Sort and create each category
         var list = od.data.get(), colour = "";
         od.config.category_order.forEach( function act_list_build_category_create ( name ) {
            if ( name.charAt(0) === '#' ) {
               // Set button colour
               colour = name.substr( 1 );

            } else if ( name === '{All}' ) {
               // Create all category button
               create_category_button( div, null, colour );

            } else {
               // Create normal category button
               var cat = od.data.get( name );
               if ( cat ) {
                  create_category_button( div, cat, colour );
                  list.splice( list.indexOf( cat ), 1 );
               }
            }
         } );
         action.l10n();
         // Create unexpected category button
         for ( var i = 0, l = list.length ; i < l ; i++ ) {
            create_category_button( div, list[i], colour );
         }
         _.show( div );
         if ( ondone ) _.call( ondone );
      }, function act_list_build_category_error () {
         od.gui.go( "update" );
      });
   },

   /** Callback for search / list, to display the results */
   'build_list' : function act_list_build_list ( col, data, counts, highlight ) {
      var action = od.action.list, cl = col.length;
      action.columns = col;
      action.data = data;
      od.gui.set_highlight( highlight );

      action.update_counts( counts );

      // Remove old table and create a new one.
      var table = _( '#act_list_pnl_list table' );
      if ( table.length ) {
         table[0].parentNode.removeChild( table[0] ); // Remove a table is 13% faster then clearing it, but both is slow when list is big
      }
      table = _.create( 'table', { 'role' : 'menubar', 'aria-label' : _.l( 'action.list.search_result', 'Result' ) } );
      var head = _.create( 'thead' );
      table.appendChild( head );

      // Headers
      for ( var i = 1 ; i < cl ; i++ ) {
         // Data field column
         var th = _.create( 'th' ), label = _.l( 'data.field.' + col[i], col[i] );
         th.appendChild( _.create( 'input', { 'type': 'search', 'class' : 'txt_filter', 'placeholder': label, 'oninput': action.txt_filter_input } ) );
         //th.appendChild( _.create( 'br' ) );
         var sorter = _.create( 'span', { 'text': '⇅', 'class': 'button' } );
         sorter.addEventListener( 'click', ( function ( f, lbl ) { return function act_list_header_click(){
            action.sort_asc = action.sort_field === f ? ! action.sort_asc : true;
            _.attr( '#act_list_pnl_list th span', 'text', '⇅' );
            lbl.textContent = action.sort_asc ? '↓' : '↑';
            action.sort_field = f;
            action.show_list();
            action.update_action_id();
         }; } )( col[ i ], sorter ) );
         th.appendChild( sorter );
         head.appendChild( th );
      }
      // Action column
      var th = _.create( 'th' );
      th.appendChild( _.create( 'input', { 'type': 'button', 'value': _.l( 'action.list.btn_clear_filter', '×' ), 'onclick': function () {
         _.attr( '.txt_filter', 'value', '' );
         action.search();
      } } ) );
      head.appendChild( th );

      action.show_list( table );
      table.addEventListener( 'click', action.table_click );
      table.addEventListener( 'keypress', function act_list_table_keypressed ( evt ) {
         if ( evt.keyCode === 13 ) action.table_click( evt ); // Trigger a click when pressing Enter
      });
      _.show( '#act_list_pnl_list' )[0].appendChild( table );
   },

   /** Filter given data and returns a copy. */
   'filter_data' : function act_list_filter_data ( col, data ) {
      var orig_len = data.length;
      _.attr( '#act_list_lbl_filter', 'text', '' );
      _.ary( _( '.txt_filter' ) ).forEach( function act_list_filter_data_col( e, i ) {
         if ( e.value ) {
            var num = e.value.match( /^(\d+[kmg]?)\s*-\s*(\d+[kmg]?)|([<>]=?)\s*(\d+[kmg]?)?|(\d+[kmg]?)([+-]?)$/i );
            if ( ! num ) {
               // Text based search; parse pattern.
               var pattern = e.value ? od.search.gen_search( e.value ) : null;
               if ( pattern ) {
                  var c = col[ i+1 ];
                  data = data.filter( function act_list_filter_data_txt_filter( e ) {
                     return pattern.regexp.test( e[ c ] );
                  } );
               }
            } else {
               // Number based search.
               var min, max, c = col[ i+1 ];
               if ( num[ 1 ] ) {
                  // Range: 123-456
                  min = Math.min( _.si( num[ 1 ] ), _.si( num[ 2 ] ) );
                  max = Math.max( _.si( num[ 1 ] ), _.si( num[ 2 ] ) );
               } else if ( num[ 3 ] ) {
                  // Open range: <=3
                  // Value may be unavaliable if user is still inputting.
                  // This is designed to aviod clearing result list after user has typed '>' or '<=' but not yet finished
                  if ( ! num[4] ) return;
                  var i = _.si( num[ 4 ] );
                  if ( num[ 3 ].substr(0,1) === '>' ) {
                     min = i;
                     if ( num[ 3 ].length > 1 ) min++;
                  } else {
                     max = i;
                     if ( num[ 3 ].length > 1 ) max--;
                  }
               } else {
                  // Open range: 5+
                  var i = _.si( num[ 5 ] );
                  if ( ! num[ 6 ] ) {
                     min = max = i;
                  } else if ( num[ 6 ] === '+' ) {
                     min = i;
                  } else {
                     max = i;
                  }
               }
               data = data.filter( function act_list_filter_data_num_filter ( e ) {
                  var val = ~~e[ c ].replace( /\D/g, '' ), low, hi;
                  //_.info( 'Num check ' + e[c] + '(' + val + ') [' + min + ',' + max + '] against ' + e[c] );
                  if ( val === 0 ) {
                     switch ( e[c].toLowerCase() ) {
                        case 'heroic' :
                           low = 1;  hi = 10;
                           break;
                        case 'paragon' :
                           low = 11; hi = 20;
                           break;
                        case 'epic' :
                           low = 21; hi = 30;
                           break;
                        default:
                           return false;
                     }
                  } else {
                     low = hi = val;
                  }
                  if ( max !== undefined && low > max ) return false;
                  if ( min !== undefined && hi  < min ) return false;
                  return true;
               } );
            }
         }
      } );
      if ( orig_len != data.length ) {
         _.attr( '#act_list_lbl_filter', 'text', _.l( 'action.list.lbl_filter', '%1/%2',  data.length, orig_len ) );
      }
      return data;
   },

   /** Sort given data and returns a copy. */
   'sort_data' : function act_list_sort_data ( data ) {
      var action = od.action.list, sorter, sort = action.sort_field;
      var ab = action.sort_asc ? 1 : -1, ba = ab * -1;
      _.time( 'Sorting ' + data.length + ' results by ' + action.sort_field );
      switch( sort ) {
         case 'Cost' :
         case 'Level' :
         case 'Price' :
            sorter = function (a,b) {
               a = od.config.level_to_int( a[ sort ] );
               b = od.config.level_to_int( b[ sort ] );
               return a > b ? ab : ( a < b ? ba : 0 );
            };
            break;
         default :
            sorter = function (a,b) {
               a = a[ sort ];
               b = b[ sort ];
               return a > b ? ab : ( a < b ? ba : 0 );
            };
      }
      return data.concat().sort( sorter );
   },

   /** List the current result, e.g. after changing sorting. */
   'show_list' : function act_list_show_list ( table ) {
      var action = od.action.list, gui = od.gui;
      var data = action.data, col = action.columns;
      var cl = col.length, idField = col[ 0 ];

      if ( ! table ) table = _( '#act_list_pnl_list table' )[0];
      _.hide( table );
      var body = _( table, 'tbody' );
      if ( body.length ) body[0].parentNode.removeChild( body[0] );
      body = _.create( 'tbody' );

      if ( ! data || data.length <= 0 ) {
         return body.appendChild( _.create( 'td', { 'rowspan' : cl+1, 'align' : 'center', 'text' : _.l( 'action.list.lbl_no_result' ) } ) );
      }

      // Fitler and sort data
      data = action.filter_data( col, data );
      if ( action.sort_field && data[0][ action.sort_field ] !== undefined ) {
         data = action.sort_data( data );
      }

      // Show data
      _.time( 'Listing ' + data.length + ' results (' + col + ')' );
      var list = [], doc = document;
      for ( var i = 0, l = data.length ; i < l ; i++ ) {
         var line = data[i];
         if ( line ) { // Create row; intensive (up to tens of thousands).  Creating it by DOM is about 18% faster then _.create.
            var row = doc.createElement( 'tr' ), cat_name = line._category.name, id = line[ idField ];
            row.setAttribute( 'role', 'menuitem' );
            row.setAttribute( 'aria-label', line.Name );
            //row.setAttribute( 'tabindex', 0 );
            row.setAttribute( 'data-id', id );
            if ( action.category === null ) row.setAttribute( 'data-category', cat_name );
            /* Building row by string is not supported by IE http://www.ericvasilik.com/2006/07/code-karma.html */// TODO: Reconsider and retest speed!
            for ( var j = 1 ; j < cl ; j++ ) { // Note: VERY intensive loop - a hundred thousand if user click 'all'.
               var td = doc.createElement('td');
               var d = line[ col[ j ] ];
               if ( d ) td.innerHTML = gui.highlight( d.text ? d.text : d );
               row.appendChild( td );
            }
            var td = doc.createElement('td');
            td.innerHTML = '<input type="checkbox" class="list_sel">';
            td.className = 'hide';
            row.appendChild( td );
            body.appendChild( row );
            list.push( cat_name + "." + id );
         }
      }
      od.action.view.siblings = list;

      table.appendChild( body );
      _.show( table ); // Android Firefox v27 needs an extra kick to trigger redraw

      _.time( 'Listed ' + data.length + ' results.' );
   }
};

})();</script>