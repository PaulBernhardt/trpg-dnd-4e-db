<!--                                                                            ex: softtabstop=3 shiftwidth=3 tabstop=3 expandtab
  - action_view.html
  - View content of an entry / multiple entries
  -->
<div id='action_view' data-role='page'>

   <header>
      <button class='i18n' onclick='od.gui.goto(od.action.list.url_current);'> action.list.link_text </button>
      <h1 id="action_view_h_title"></h1>
   </header>

   <article id="act_view_pnl_content"></article>
</div>

<script type='text/javascript'>'use strict';(function action_view_init(){
od.action.view = {

   "initialize" : null,

   "setup" : function action_view_setup () {
      this.clear();
      var idList = location.search.substr( '?view='.length ).split( ',' );
      var title = this.title = new Array( idList.length );
      this.update_title;
      // Load main data listing, so that ?list will not think we already loaded
      od.data.load_catalog( function act_view_cat_load () {
         idList.forEach( function act_view_show_each ( id, i ) {
            // Parse id
            id = id.match( /^([^.]+?)\.(.+)$/ ) || ['','',''];
            var cat = od.data.create( id[ 1 ] );
            id = id[ 2 ];
            if ( ! cat || ! id ) return;
            _.debug( "Display " + cat.name + "." + id );
            // Create div
            var div = _.create( 'div' );
            _( '#act_view_pnl_content')[0].appendChild( div );
            // Load and fill div
            cat.load_data( id, function act_view_show_load () {
               var content = cat.data[ id ];
               div.innerHTML = od.gui.highlight( content );
               var h1 = content.match( /<h1[^>]*>(.+)<\/h1\s*>/ );
               if ( h1 ) title[i] = h1[1].replace( /<span[^>]*>.*<\/span>|<br\/?>/g, '' );
               od.action.view.update_title();
            } );
         } );
      } );
   },

   "cleanup" : function action_view_cleanup () {
      this.clear();
   },

   /////////////////////////////////////////////////////////////////////////////////////////////////
   
   "title" : [],

   "clear" : function act_view_clear () { _( '#act_view_pnl_content')[0].innerHTML = ""; },
   
   "update_title" : function act_view_update_title () {
      if ( this.title.length === 1 && this.title[0] ) {
         _('#action_view_h_title')[0].textContent = this.title[0];
      } else {
         _('#action_view_h_title')[0].textContent = _.l( 'action,view.title', null, idList.length );
      }
   }
};

})();</script>