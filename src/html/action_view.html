<!--                                                                            ex: softtabstop=3 shiftwidth=3 tabstop=3 expandtab
  - action_view.html
  - View content of an entry / multiple entries
  -->
<section id='action_view' ontouchstart="od.action.view.touch_start(event)" ontouchend="od.action.view.touch_end(event)">
   <style scoped>
      .btn_prevnext {
         position: absolute;
         margin: auto;
         top: 0; left: 1ex; bottom: 0; right: 1ex;
         height: 2cm; width: 2cm;
         border-radius: 1cm;
         font-size: 1cm;
         opacity: 0.3;
      }
      @media (max-width: 12cm) {
         .btn_prevnext {
            height: 1cm; width: 1cm;
            border-radius: 0.5cm;
            font-size: 0.5cm;
         }
      }
      #action_view_btn_prev {
         margin-left: 0;
      }
      #action_view_btn_next {
         margin-right: 0;
      }
   </style>
   <nav>
      <button id="action_view_btn_prev" class="btn_prevnext" onclick="od.action.view.btn_prev_click()">&lt;</button>
      <button id="action_view_btn_next" class="btn_prevnext" onclick="od.action.view.btn_next_click()">&gt;</button>
   </nav>
   <article id="act_view_pnl_content"></article>
   <header role="navigation">
      <button class='i18n' onclick='od.gui.goto(od.action.list.url_current);' accesskey='1'> action.list.link_text </button>
      <h1 id="action_view_h_title"></h1>
   </header>
</section>

<script type='text/javascript'>'use strict';(function action_view_init(){
od.action.view = {

   "initialize" : null,

   "l10n" : function act_view_l10n() {
      var action = od.action.view, id = action.act_id;
      if ( id && id.length ) {
         action.set_title( _.l( 'action.view.title', '%1 entries', action.id.length ) );
      }
   },

   "setup" : function act_view_setup () {
      this.parse_action_id();
   },

   "cleanup" : function act_view_cleanup () {
      this.clear();
   },

   'update_action_id' : function act_list_update_action_id () {
      var action = od.action.view;
      if ( action.act_id instanceof Array ) {
         od.gui.pushState( "view=" + action.act_id.join( ',' ) );
      } else {
         od.gui.pushState( "view=" + action.act_id );
      }
   },

   'parse_action_id' : function act_list_parse_action_id () {
      var id = od.gui.act_id, action = od.action.view;
      var idList = id.substr( 'view='.length ).split( ',' );
      action.clear();
      idList.forEach( function act_view_show_each ( id, i ) {
         // Parse id
         id = id.match( /^([^.]+?)\.(.+)$/ ) || ['','',''];
         var cat = od.data.create( id[ 1 ] );
         id = id[ 2 ];
         if ( ! cat || ! id ) return;
         _.debug( "Display " + cat.name + "." + id );
         // Create div
         var div = _.create( 'div' );
         _( '#act_view_pnl_content')[0].appendChild( div );
         // Load and fill div
         cat.load_data( id, function act_view_show_load () {
            var content = cat.data[ id ];
            div.innerHTML = od.gui.highlight( content );
            if ( idList.length === 1 ) {
               var h1 = content.match( /<h1[^>]*>(.+?)<\/h1\s*>/ );
               action.set_title( h1[1].replace( /<(\w+)[^>]*>.*<\/\1>|<br\/?>/g, '' ) );
            }
         } );
      } );

      action.act_id = idList && idList.length > 0 ? ( idList.length === 1 ? idList[ 0 ] : idList ) : null;
      action.l10n();
      action.update_nav_button();
   },

   "btn_prev_click" : function act_view_btn_prev_click () {
      var action = od.action.view;
      var pos = action.siblings.indexOf( action.act_id );
      if ( pos <= 0 ) return _.hide( '#action_view_btn_prev' );
      action.act_id = action.siblings[ pos-1 ];
      action.update_action_id();
      action.parse_action_id();
   },

   "btn_next_click" : function act_view_btn_next_click () {
      var action = od.action.view;
      var pos = action.siblings.indexOf( action.act_id );
      if ( pos >= action.siblings.length-1 ) return _.hide( '#action_view_btn_next' );
      action.act_id = action.siblings[ pos+1 ];
      action.update_action_id();
      action.parse_action_id();
   },

   "touch_start" : function act_view_touch_start ( evt ) {
      od.action.view.touch_start.point = evt.touches[0];
   },

   "touch_end" : function act_view_touch_end ( evt ) {
      var start = od.action.view.touch_start.point, end = evt.touches[0];
      if ( ! start || ! end ) return;
      var dy = end.screenY - start.screenY, dx = Math.abs( end.screenX - start.screenX ), slope = Math.abs( dy ) / dx;
      if ( slope < 0.2 && Math.abs( dy ) > 70 ) {
         od.action.view[ "btn_" + ( dy < 0 ? "left" : "right" ) + "_click" ]();
         evt.preventDefault();
      }
   },

   /////////////////////////////////////////////////////////////////////////////////////////////////

   "act_id" : null, // Current view id, an array of or a single "cat.id"

   /**
    * List of siblings, plus current entry, in "cat.id" and in display order.
    * Used to find prev / next entry.
    */
   "siblings" : [],

   "clear" : function act_view_clear () { _( '#act_view_pnl_content')[0].innerHTML = ""; },
   
   "set_title" : function act_view_set_title ( title ) {
      _('#action_view_h_title')[0].textContent = title;
      od.gui.update_title();
   },

   "update_nav_button" : function update_nav_button () {
      var action = od.action.view;
      _.hide( '.btn_prevnext' );
      if ( ! action.siblings || action.siblings.length <= 1 || ! action.act_id || action.act_id instanceof Array ) return;
      var pos = action.siblings.indexOf( action.act_id );
      if ( pos < 0 ) return;
      if ( pos > 0 ) _.show( '#action_view_btn_prev' );
      if ( pos < action.siblings.length-1 ) _.show( '#action_view_btn_next' );
   }
};

})();</script>