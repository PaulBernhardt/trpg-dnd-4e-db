<!--                                                                            ex: softtabstop=3 shiftwidth=3 tabstop=3 expandtab
  - action_view.html
  - View content of an entry / multiple entries
  -->
<div id='action_view' data-role='page'>
   <style scoped>
      .btn_prevnext {
         position: absolute;
         margin: auto;
         top: 0; left: 1ex; bottom: 0; right: 1ex;
         height: 2cm; width: 2cm;
         border-radius: 1cm;
         font-size: 1cm;
         opacity: 0.3;
      }
      @media (max-width: 12cm) {
         .btn_prevnext {
            height: 1cm; width: 1cm;
            border-radius: 0.5cm;
            font-size: 0.5cm;
         }
      }
      #action_view_btn_prev {
         margin-left: 0;
      }
      #action_view_btn_next {
         margin-right: 0;
      }
   </style>
   <nav>
      <button id="action_view_btn_prev" class="btn_prevnext" title="action.view.btn_prev" class="i18n">&lt;</button>
      <button id="action_view_btn_next" class="btn_prevnext" title="action.view.btn_next" class="i18n">&gt;</button>
   </nav>
   <article id="act_view_pnl_content"></article>
   <header role="navigation">
      <button class='i18n' onclick='od.gui.goto(od.action.list.url_current);' accesskey='1'> action.list.link_text </button>
      <h1 id="action_view_h_title"></h1>
   </header>
</div>

<script type='text/javascript'>'use strict';(function action_view_init(){
od.action.view = {

   "initialize" : null,

   "setup" : function action_view_setup () {
      this.clear();
      this.parse_action_id();
   },

   "cleanup" : function action_view_cleanup () {
      this.clear();
   },

   'parse_action_id' : function act_list_parse_action_id ( ) {
      var id = od.gui.act_id, action_list = od.action.list;
      var idList = id.substr( 'view='.length ).split( ',' );
      var title = this.title = new Array( idList.length );
      this.update_title;
      idList.forEach( function act_view_show_each ( id, i ) {
         // Parse id
         id = id.match( /^([^.]+?)\.(.+)$/ ) || ['','',''];
         var cat = od.data.create( id[ 1 ] );
         id = id[ 2 ];
         if ( ! cat || ! id ) return;
         _.debug( "Display " + cat.name + "." + id );
         // Create div
         var div = _.create( 'div' );
         _( '#act_view_pnl_content')[0].appendChild( div );
         // Load and fill div
         cat.load_data( id, function act_view_show_load () {
            var content = cat.data[ id ];
            div.innerHTML = od.gui.highlight( content );
            var h1 = content.match( /<h1[^>]*>(.+)<\/h1\s*>/ );
            if ( h1 ) title[i] = h1[1].replace( /<(\w+)[^>]*>.*<\/\1>|<br\/?>/g, '' );
            od.action.view.update_title();
         } );
      } );

      this.act_id = idList && idList.length > 0 ? ( idList.length > 1 ? idList[ 0 ] : idList ) : null;
      this.update_nav_button();
   },

   /////////////////////////////////////////////////////////////////////////////////////////////////
   
   "title" : [],

   "act_id" : null, // Current view id, an array of or a single "cat.id"

   /**
    * List of siblings, plus current entry, in "cat.id" and in display order.
    * Used to find prev / next entry.
    */
   "siblings" : [],

   "clear" : function act_view_clear () { _( '#act_view_pnl_content')[0].innerHTML = ""; },
   
   "update_title" : function act_view_update_title () {
      if ( this.title.length === 1 && this.title[0] ) {
         _('#action_view_h_title')[0].textContent = this.title[0];
      } else {
         _('#action_view_h_title')[0].textContent = _.l( 'action,view.title', null, idList.length );
      }
   },

   "update_nav_button" : function update_nav_button () {
      var action = od.action.view;
      _.hide( '.btn_prevnext' );
      if ( ! action.siblings || action.siblings.length <= 1 || ! action.act_id ) return;
      var pos = action.siblings.indexOf( action.act_id );
      if ( pos < 0 ) return;
      if ( pos > 0 ) _.show( '#action_view_btn_prev' );
      if ( pos < action.siblings.length-1 ) _.show( '#action_view_btn_next' );
   }
};

})();</script>