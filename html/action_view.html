<!--
  - action_view.html
  - View content of an entry / multiple entries
  -->
<section id='action_view'>
   <nav>
      <button id="act_view_btn_prev" class="btn_prev" onclick="od.action.view.btn_prev_click()">&lt;</button>
      <button id="act_view_btn_next" class="btn_next" onclick="od.action.view.btn_next_click()">&gt;</button>
   </nav>
   <article id="act_view_pnl_content" contextmenu="menu_view" onclick="od.action.view.find_selected()"></article>
   <header role="navigation">
      <button class='i18n' onclick='od.gui.go("list");' accesskey='1'> action.list.link_text </button>
      <h1 id="act_view_h_title"></h1>
      <button class='i18n' onclick='scrollTo(0,0)'> gui.top </button>
   </header>
</section>

<script><?coco-start js(minify) ?>   'use strict';(function action_view_init(){
od.action.view = {

   "initialize" : null,

   "l10n" : function act_view_l10n() {
      var action = od.action.view, id = action.act_id;
      if ( id && id.length ) {
         action.set_title( _.l( 'action.view.title', '%1 entries', action.id.length ) );
      }
   },

   "setup" : function act_view_setup () {
      this.parse_action_id();
   },

   "cleanup" : function act_view_cleanup () {
      this.clear();
   },

   'update_action_id' : function act_list_update_action_id () {
      var action = od.action.view;
      if ( action.act_id instanceof Array ) {
         od.gui.pushState( "view=" + action.act_id.join( ',' ) );
      } else {
         od.gui.pushState( "view=" + action.act_id );
      }
   },

   'parse_action_id' : function act_view_parse_action_id () {
      var id = od.gui.act_id, action = od.action.view;
      var idList = id.substr( 'view='.length ).split( ',' );
      action.clear();
      idList.forEach( function act_view_show_each ( id ) {
         // Parse id
         _.info( "Parsing " + id );
         var cat = od.data.create( od.data.category_name_of( id ) );
         _.info( "Display " + cat.name + "." + id );
         // Create div
         var div = _.html( '<div>' + _.l( 'gui.loading', 'Loading' ) + '</div>' );
         _( '#act_view_pnl_content')[0].appendChild( div );
         // Load and fill div
         cat.load_data( id, function act_view_show_load () {
            var content = '<div id="detail">' + cat.data[ id ] + '</div>';
            div.innerHTML = od.gui.highlight( content );
            if ( idList.length === 1 ) {
               var h1 = content.match( /<h1[^>]*>(.+?)<\/h1\s*>/ );
               action.set_title( h1[1].replace( /<(\w+)[^>]*>.*<\/\1>|<br\/?>/g, '' ) );
            }
         } );
      } );

      action.act_id = idList && idList.length > 0 ? ( idList.length === 1 ? idList[ 0 ] : idList ) : null;
      action.l10n();
      action.update_nav_button();
   },

   "btn_prev_click" : function act_view_btn_prev_click () {
      var action = od.action.view;
      var pos = action.siblings.indexOf( action.act_id );
      if ( pos <= 0 ) return _.hide( '#act_view_btn_prev' );
      action.act_id = action.siblings[ pos-1 ];
      action.update_action_id();
      action.parse_action_id();
   },

   "btn_next_click" : function act_view_btn_next_click () {
      var action = od.action.view;
      var pos = action.siblings.indexOf( action.act_id );
      if ( pos >= action.siblings.length-1 ) return _.hide( '#act_view_btn_next' );
      action.act_id = action.siblings[ pos+1 ];
      action.update_action_id();
      action.parse_action_id();
   },

   /////////////////////////////////////////////////////////////////////////////////////////////////

   "act_id" : null, // Current view id, an array of or a single "cat.id"

   /**
    * List of siblings, plus current entry, in "cat.id" and in display order.
    * Used to find prev / next entry.
    */
   "siblings" : [],

   "clear" : function act_view_clear () { _( '#act_view_pnl_content')[0].innerHTML = ""; },

   "set_title" : function act_view_set_title ( title ) {
      _('#act_view_h_title')[0].textContent = title;
      od.gui.update_title();
   },

   "update_nav_button" : function act_view_update_nav_button () {
      var action = od.action.view;
      _.hide( '#act_view_btn_prev, #act_view_btn_next' );
      if ( ! action.siblings || action.siblings.length <= 1 || ! action.act_id || action.act_id instanceof Array ) return;
      var pos = action.siblings.indexOf( action.act_id );
      if ( pos < 0 ) return;
      if ( pos > 0 ) _.show( '#act_view_btn_prev' );
      if ( pos < action.siblings.length-1 ) _.show( '#act_view_btn_next' );
   },

   "find_selected" : function act_view_find_selected () {
      var sel = window.getSelection(),  range = sel.getRangeAt(0),  node = sel.anchorNode;
      var allowed_tag = [ undefined /* text */, 'span', 'mark' ];

      function findPre( node, len, offset ) {
         var text = node.textContent, part = '';
         if ( text.length ) {
            if ( offset === undefined ) offset = text.length;
            part = text.substring( offset-Math.min( offset, len ) , offset );
            len -= part.length;
            if ( len <= 0 ) return part;
         }
         if ( ! node.previousSibling )
            do {
               node = node.parentNode;
            } while ( ! node.previousSibling && node.parentNode && allowed_tag.indexOf( node.tagName ) >= 0 );
         return node.previousSibling
            ? findPre( node.previousSibling, len ) + part
            : part;
      }

      function findPost( node, len, offset ) {
         var text = node.textContent, part = '';
         if ( text.length ) {
            if ( offset === undefined ) offset = 0;
            part = text.substring( offset, Math.min( text.length, offset+len ) );
            len -= part.length;
            if ( len <= 0 ) return part;
         }
         if ( ! node.nextSibling )
            do {
               node = node.parentNode;
            } while ( ! node.nextSibling && node.parentNode && allowed_tag.indexOf( node.tagName ) >= 0 );
         return node.nextSibling
            ? findPre( node.nextSibling, len ) + part
            : part;
      }

      var pre  = findPre ( node, 45, range.startOffset );
      var post = findPost( node, 45, range.endOffset   );

      console.log( pre + post );
   }
};

})();<?coco-end?></script>