# Offline 4e Compendium v3 High Level Design Doc #

Last updated: 2015-07-08

## 1. Introduction ##
### 1.1 Background ###
This product is a pure javascript fan-made script for downloading entries from official compendium of D&D 4th edition, store them locally, and provides a mean to browse and search saved entries.
These actions does not breach copyright.

The aim is to provide important capabilities that is lacked by the official compendium, such as offline access, advanced search, or multiple entry display.  It is also hoped that this unofficial counterpart will provide a better user experience both on desktop and mobile devices.

For copyright and trademark reasons, the product name must not contains the name of the TRPG system it is designed for, and must not contain copyrighted materials, including images and styles used in the offical site.
To comply with AGPL license, the deliverable should comes in source code and with full license.

### 1.2 Design Goals ###
1. Javascript based, with embedded Java program to manage download and indexing.
2. Can completely run offline once entries has been retrieved or copied from other source.
3. Both program and data can be copied/transferred easily across machines, e.g. from PC to phone.
4. Scalable (low memory and cpu footprint) for 25k+ entries, ideally should run on low end smartphones.
5. Single file deliverable for easy deployment and update.
6. Cross platforms, both desktops and mobiles (min. 320x480).
7. Intuitive, elegance, and impressive.
8. Support multiple languages, starting with English and Chinese.



## 2. Architecture ##
### 2.1 Introduction ###

The main deliverable is an HTML5 webpage that handles offline data searching and browsing. <br>
It embeds a Java application to download and index compendium data, which must be saved and executed alone to escape the browser's sandbox.

For easy deployment, images and other resources are embeded <br>
For easy transfer of program state, all local data is stored in '(name of deliverable)_files' folder, so that windows will copy it together with the program. <br>
For a balance between ease of development and platform support, the application use ECMAScript version 5 strict mode and only support latest modern browsers.

### 2.2 Use Cases ###

1. First run
 * A quick intro and button to download embedded app.
 * url: ?intro

2. Search / List
 * url: ?list.name.(category.name)=(term)&(field1)=(term1)&(field2)=(term2)&...
 * url: ?list.full.(category.name)=(term)&(field1)=(term1)&(field2)=(term2)&...
 * Simple, intuitive, but with access to advanced features.
 * Should be light weight and suitable for mobile use.
 * Additional parameters: order=(column)( desc?) (This means 'order' column is unsearchable.)

3. View Entries
 * multi view url : ?view=(category1.name).(id1),(category2.name).(id2),...
 * single view url: Same as Search / List, plus #(category.name).(id)
 * Should support nice print outs, perhaps multi-columns.

4. Config
 * url: ?config
 * Access to system configuration.

5. Help
 * url: ?help
 * Guide on search and features.

6. License
 * url: ?license
 * View script license

Considering that these actions are distinct, the application use a page layout design, where each 'page' fills whole screen and focus on one task.
The layout is responsive so that the same page may shows differently on different devices.

Future versions may support more advanced views for desktop, such as 'list and content' for view entries use case.

### 2.3 Code Files ###

The code is separated into a few main parts.  All runtime resources are compiled into a single deliverable file.

1. **Binders**
 * build.xml - Ant build that compiles deliverable.
 * html/html_template.html - Main deliverable's skeleton code.
 * html/config.js - Default application config.

2. **UI**
 * html/action_*.html - Various pages, one html for each action.
 * html/images.html - Most images are embedded here, to keep other code small.
 * html/style_*.css - CSS styles.
 * html/code_gui.js - Common UI logic, such as page switching.
 * html/lang_*.js - l10n resources, including small images if necessary (in Base64). Fallback language is English.

3. **Logic**
 * html/data_model.js - Contains data model, including index and listing.
 * html/data_update.js - Handles data update logic, including a remote data model.
 * html/data_search.js - Handles search logic.
 * html/data_writer.js - Handles actual writing of data, so that model doesn't need to concern save format.
 * html/data_reader.js - Handles actual reading of data, so that model doesn't need to concern save format or backward compatibility.

4. **Helpers**
 * html/sparrow.js - Self developed lightweight js library, including helpers and l10n system.
 * java/Proxy.java - Java applet code for COR and file IO.
 * cert/keystore.jks - For signing applet.

### 2.4 Data Structure ###

As explained in 2.1, all data is optional and resides in a data folder.

Because of certain browser's limitation on local AJAX, all JS data are in JSONP format, except that the callback function is pre-determined.
All JS data must contain version string so that future code can maintain backward compatibility.

Although category names may be displayed localised (cat.title), the actual name is always the one returned from server.

* catalog.js - List categories and total # entries of each.
* (Category name)/_raw.js - Main raw listing of a category's entries, used only for reindex.
* (Category name)/_listing.js - Processed listing of a category's entries, with parsed info.
* (Category name)/_index.js - Text index of all entries in a category.
* (Category name)/xxxxYYYY.js - Individual data content. File name is based on id.
* config.js - Contains user's preference, such as saved clipboard.
* app.manifest - web application manifest.
* cache.manifest - cache manifest, need to be updated by data writer.